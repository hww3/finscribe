  <%@include file="top.phtml"%>
   <title><%syspref var="site.name" %> :: admin :: preferencelist</title>
  <%@include file="header.phtml"%>
  <script type="application/x-javascript">
    dojo.require("dojo.widget.*");
    dojo.require("dojo.event.*");
    dojo.require("fins.widget.*");
    dojo.require("dojo.widget.InlineEditBox");
    dojo.require("fins.widget.InlineBooleanBox");
    dojo.require("dojo.widget.Tree");
    dojo.require("dojo.widget.TreeRPCController");
    dojo.require("dojo.widget.TreeSelector");
    dojo.require("dojo.widget.TreeNode");


	var reporter = function(reporter) {
		this.name = eventName;
		this.go = function(message) {
			var rep = [ reporter + " -- event: "+this.name ];
			for(i in message) rep.push(i+": "+message[i]);
			dojo.debug(rep.join(', '));
		}
	}


    function init() {
    <% foreach var="preferences" val="preference" %>
      dojo.widget.byId('<%$preference.Name%>').onSave = createCallback('<%$preference.Name%>');<% end %>

		var controller = dojo.widget.manager.getWidgetById('treeController');
		for(eventName in controller.eventNames) {
			dojo.event.topic.subscribe(
				controller.eventNames[eventName],
				new reporter('controller'),
				'go'
			);
		}

		/* Add debug print for all prefTree events */
		var prefTree = dojo.widget.manager.getWidgetById('prefTree');


		for(eventName in prefTree.eventNames) {
			dojo.event.topic.subscribe(
				prefTree.eventNames[eventName],
				new reporter('prefTree'),
				'go'
			);
		}

    }

    dojo.addOnLoad(init);

    function createCallback(pref) {
      return function(newVal, oldVal) { saveHandler(pref, newVal, oldVal); };
    }

    function saveHandler(pref, newVal, oldVal) {
      var bindArgs = {
	url : '/admin/prefs/set',
	mimetype : 'text/plain',
	sync : false,
	method : 'POST',
	content : {
		    key : pref,
		    value : newVal
		  },
	error : function(type, errObj) {
		},
	load : function(type, data, evt) {
	       }
      };
      dojo.io.bind(bindArgs);
    }
  </script>
<%@include file="pagebegin.phtml"%>
<div class="flash-message"><%flash var="msg"%></div>
          <h3>Preference List</h3>

<div dojoType="TreeRPCController" RPCUrl="/admin/prefs/tree" widgetId="treeController"></div>
<div dojoType="TreeSelector" widgetId="treeSelector"></div>
<div dojoType="Tree" selector="treeSelector" actionsDisabled="addChild" 
  toggler="fade" widgetId="prefTree" controller="treeController">
    <div dojoType="TreeNode" widgetId="1.1" title="Preferences" actionsDisabled="remove">
<% foreach var="prefprefixes" val="prefix" %>
	<div dojoType="TreeNode" widgetId="tree_<%$prefix%>" title="<%$prefix%>" isFolder="true"></div>
<% end %>
	</div>
</div>


        <form action="" method="post">
          Starts with: <input type="text" size="10" name="startswith"/> <input type="submit" 
name="search" value="Show"/>
        </form>
        
        <table>
            <tr><td><b>Preference Name</b></td><td><b>Value</b></td><td> &nbsp; </td></tr>
          <% foreach var="preferences" val="preference"%>
        <tr>
            <td><%$preference.Name%></td>
<% if data["preference"]["Type"] == FinScribe.BOOLEAN %>
	    <td><div id="<%$preference.Name%>" dojoType="inlineBooleanBox"><%$preference.BooleanValue%></div></td>
<% else %>
	    <td><div id="<%$preference.Name%>" dojoType="inlineEditBox"><%$preference.Value%></div></td>
<% endif %>
        </tr>
          <% end %>
        </table>

  <%@include file="footer.phtml"%>
  <%@include file="bottom.phtml"%>

