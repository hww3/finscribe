
	<style type="text/css">
		@import "/static/javascripts/dojo/resources/dojo.css";
		@import "/static/javascripts/dijit/themes/dijit.css";
		@import "/static/javascripts/dijit/themes/tundra/form/Button.css";		
	</style>
        <style>
		#wrapper{
			width:100%;
		}
		
		.browse{
		
		}
		#uploadBtn{
		
		}
		.uploadBtn{
	
		}
		#fileToUpload{
		border:#CCCCCC 1px solid;
		overflow-y:auto;
		overflow-x:hidden;
		}
		.uploadedFilesLabel{
		
		}
		#uploadedFiles{
		border:#CCCC00 1px solid;
		background:#FFFFCC;
		}
		.leftCol{
		width:500px;
		padding:5px;
		vertical-align:top;
		}
		.rgtCol{
		vertical-align:top;
		}
		textarea{
		display:block;
		}
		#noFlash button, #hasFlash button{
		font-size:9px;
		}
	</style>


<h2><%LOCALE id="195" string="Editing Attachments"%></h2>
<p>
<%$flash%>
<p>
<div id="attachments">
<% if data->object_is_weblog %>
  <%LOCALE id="196" string="You can't directly add attachments to a weblog page."%>
<% else %>
  <%LOCALE id="79" string="This page"%> (<%$object.path%>) <%LOCALE id="80" string="contains"%> <%$numattachments %> <%LOCALE id="81" string="Attachments"%></a><br/>
  <table>
  <tr><th><%LOCALE id="82" string="Name"%></th><th><%LOCALE id="83" string="Type"%></th><th><%LOCALE id="84" string="Size"%></th><th></th></tr>
  <% foreach var="$attachments" val="attachment" %>
  <tr><td><img src="/static/images/attachment/<%$attachment.icon%>"> <a href="/space/<%$attachment.path%>"><%$attachment.title%></a></td>
  <td><%$attachment.datatype.mimetype%></td>
  <td><%$attachment.current_version.content_length%></td>
  <td><a onclick="document.getElementById('action').value='Delete'; 
document.getElementById('filename').value='<%$attachment.path%>'; saveAttachment('<%$object.path%>', 
'attachmentform'); return false;"><%LOCALE id="146" string="Delete"%></a></td>
  </tr>
  <%end %>
  </table>
<!-- for the ajaxy stuff. -->
<form action="" method="post" enctype="multipart/form-data" id="attachmentform"> 
<input type="hidden" name="action" id="action"/>
<input type="hidden" name="filename" id="filename"/>
</form>


<form dojoType="dijit.form.Form">
<table>
<tr>
<td>
        <div id="btn0" class="browse" dojoType="dijit.form.Button">Select Images...</div>
        <span id="fTypes">Choose from these types:</span>
        
        <textarea cols="30" rows="6" id="fileToUpload"></textarea>
</td>
</tr>
<tr>
<td>        
        <div id="uploadBtn" class="uploadBtn" onClick="doUpload();" dojoType="dijit.form.Button">Upload</div>       
</td></tr>
</table>
</form>

<% endif %>
</div>


	<script>
		passthrough = function(msg){
			//for catching messages from Flash
			if(window.console){
				console.log(msg);	
			}
		}
		selectMultipleFiles = true;

function saveAttachment(obj, formid, noanim)
{
  var bindArgs = {
    url:        "/exec/editattachments/" + obj,
    content: {ajax: "1"},
    mimetype:   "text/html",
    error:      function(type, errObj){
    },
    load:      function(data){
        // handle successful response here
        var d = document.getElementById("popup_contents");
        if(!d)
          return;
        else
            d.innerHTML = data;

    }
  };

  if(formid)
  {
    var form = document.getElementById(formid);
    if(form)
      bindArgs.form = form;
  }

// dispatch the request
    var requestObj = dojo.xhrPost(bindArgs);

}

		 
    </script>
	<script type="text/javascript">
		dojo.require("dojox.form.FileUploader");
		dojo.require("dijit.form.Form"); 
		dojo.require("dijit.form.Button"); 
		dojo.require("dojo.parser");
		
		//using this early for the forceNoFlash test:
		dojo.require("dojox.embed.Flash");

		dojo.parser.parse(dojo.byId("attachments"));		

		// FIXME: well, actually there's nothing we can do about this. blame adobe.
                //        also, blame the moron who designed the uploadUrl architecture. 
		var uploadUrl = "<%syspref var="site.url"%>/exec/addattachments/<%$object.path%>?path=<%$object.path%>&PSESSIONID=<%sessionid%>";
		
		var fileMask = 	["All Files", 	"*.*"];
		
		var make_it_happen = function(){
				if(dojo.isArray(fileMask[0])){
					dojo.byId("fTypes").innerHTML+=fileMask[fileMask.length-1][1];
				}else{
					dojo.byId("fTypes").innerHTML+=fileMask[1];
				}
			
			dojo.byId("fileToUpload").value = "";
	
			var f0;
//			f0 = dijit.byId("btn0");
//                        if(f0) f0.destroy();
 
                        f0 = new dojox.form.FileUploader({
				button:dijit.byId("btn0"), 
				degradable:true,
				uploadUrl:uploadUrl, 
				uploadOnChange:false, 
				selectMultipleFiles:selectMultipleFiles,
				fileMask:fileMask,
				isDebug:true
			});
			
			doUpload = function(){
				dojo.byId("fileToUpload").innerHTML = "uploading...";
				f0.upload();
			}
			dojo.connect(f0, "onChange", function(data){
				console.log("DATA:", data);
				dojo.forEach(data, function(d){
					//file.type no workie from flash selection (Mac?)
					if(selectMultipleFiles){
						dojo.byId("fileToUpload").value += d.name+" "+Math.ceil(d.size*.001)+"kb \n";
					}else{
						dojo.byId("fileToUpload").value = d.name+" "+Math.ceil(d.size*.001)+"kb \n";
					}
				});
			});
			dojo.connect(f0, "onProgress", function(data){
				dojo.byId("fileToUpload").value = "";
				dojo.forEach(data, function(d){
					dojo.byId("fileToUpload").value += "("+d.percent+"%) "+d.name+" \n";
					
				});
			});

			dojo.connect(f0, "onComplete", function(data){
				dojo.forEach(data, function(d){
					alert( d.file+" \n");
				});
			});

			
			Destroy = function(){
				f0.destroyAll();
			}
			
		};
		make_it_happen();
		
	</script>
</div>

